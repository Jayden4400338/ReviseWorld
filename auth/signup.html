<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign Up - BrainMapRevision</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../assets/css/auth.css" />
    <link rel="shortcut icon" href="../assets/images/shortcut-icon.png" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <svg
            class="logo-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"
            />
            <path
              d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"
            />
          </svg>
          <span class="logo-text">BrainMapRevision</span>
        </div>

        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <span></span>
          <span></span>
          <span></span>
        </button>

        <div class="nav-menu" id="navMenu">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="login.html" class="nav-link">Login</a>
          <button
            class="theme-toggle"
            id="themeToggle"
            aria-label="Toggle dark mode"
          >
            <svg
              class="sun-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="5" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
              <line x1="1" y1="12" x2="3" y2="12" />
              <line x1="21" y1="12" x2="23" y2="12" />
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
            </svg>
            <svg
              class="moon-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
          </button>
        </div>
      </div>
    </nav>

    <!-- Sign Up Form -->
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1 class="auth-title">Create Your Account</h1>
          <p class="auth-subtitle">Start your revision journey today</p>
        </div>

        <form id="signupForm" class="auth-form">
          <!-- Role Selection -->
          <div class="form-group">
            <label class="form-label">I am a:</label>
            <div class="role-selection">
              <label class="role-option">
                <input type="radio" name="role" value="student" checked />
                <div class="role-card">
                  <svg
                    class="role-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                  </svg>
                  <span class="role-title">Student</span>
                </div>
              </label>
              <label class="role-option">
                <input type="radio" name="role" value="teacher" />
                <div class="role-card">
                  <svg
                    class="role-icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                  </svg>
                  <span class="role-title">Teacher</span>
                </div>
              </label>
            </div>
          </div>

          <!-- Username -->
          <div class="form-group">
            <label for="username" class="form-label">Username</label>
            <input
              type="text"
              id="username"
              class="form-input"
              placeholder="Choose a unique username"
              required
              minlength="3"
              maxlength="50"
            />
            <small class="form-hint" id="usernameHint"
              >3-50 characters, letters, numbers, and underscores only</small
            >
          </div>

          <!-- Email -->
          <div class="form-group">
            <label for="email" class="form-label">Email Address</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="your.email@example.com"
              required
            />
            <small class="form-hint" id="emailHint"
              >We'll send a verification email</small
            >
          </div>

          <!-- Password -->
          <div class="form-group">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              id="password"
              class="form-input"
              placeholder="Create a strong password"
              required
            />
            <small class="form-hint">At least 8 characters</small>
          </div>

          <!-- Confirm Password -->
          <div class="form-group">
            <label for="confirmPassword" class="form-label"
              >Confirm Password</label
            >
            <input
              type="password"
              id="confirmPassword"
              class="form-input"
              placeholder="Re-enter your password"
              required
            />
          </div>

          <!-- Year Group (Student only) -->
          <div class="form-group" id="yearGroupSection">
            <label for="yearGroup" class="form-label">Year Group</label>
            <select id="yearGroup" class="form-select">
              <option value="">Select your year</option>
              <option value="year-1">Year 1</option>
              <option value="year-2">Year 2</option>
              <option value="year-3">Year 3</option>
              <option value="year-4">Year 4</option>
              <option value="year-5">Year 5</option>
              <option value="year-6">Year 6</option>
              <option value="year-7">Year 7</option>
              <option value="year-8">Year 8</option>
              <option value="year-9">Year 9</option>
              <option value="year-10">Year 10</option>
              <option value="year-11">Year 11</option>
            </select>
          </div>

          <!-- Error Message -->
          <div
            id="errorMessage"
            class="error-message"
            style="display: none"
          ></div>

          <!-- Submit Button -->
          <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
            <span>Create Account</span>
            <svg
              class="btn-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="5" y1="12" x2="19" y2="12" />
              <polyline points="12 5 19 12 12 19" />
            </svg>
          </button>

          <!-- Login Link -->
          <p class="auth-footer">
            Already have an account?
            <a href="login.html" class="auth-link">Log in</a>
          </p>
        </form>
      </div>
    </div>

    <!-- Load Environment Configuration FIRST -->
    <script src="../assets/js/env-config.js"></script>
    
    <!-- Load Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Inline Supabase Config & Auth Logic -->
    <script>
      // ==========================================
      // SUPABASE CONFIGURATION
      // ==========================================
      // Get configuration from environment (set by env-config.js)
      const SUPABASE_URL = window.__ENV__?.SUPABASE_URL || "https://qqbyxydxxcuklakvjlfr.supabase.co";
      const SUPABASE_ANON_KEY = window.__ENV__?.SUPABASE_ANON_KEY || "Your-anon-key-here";

      // Initialize Supabase client - ONLY CREATE ONCE
      if (!window.supabaseClient) {
        window.supabaseClient = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY,
        );
      }

      // Use the global client
      const supabaseClient = window.supabaseClient;

      // ==========================================
      // USERNAME VALIDATION
      // ==========================================
      const usernameInput = document.getElementById("username");
      const usernameHint = document.getElementById("usernameHint");

      // Real-time username validation
      usernameInput.addEventListener("input", (e) => {
        const username = e.target.value;

        // Check format (alphanumeric and underscores only)
        const validFormat = /^[a-zA-Z0-9_]+$/.test(username);

        if (username.length > 0 && !validFormat) {
          usernameHint.textContent =
            "⚠️ Only letters, numbers, and underscores allowed";
          usernameHint.style.color = "#F56565";
          e.target.style.borderColor = "#F56565";
        } else if (username.length >= 3) {
          usernameHint.textContent = "✓ Valid format";
          usernameHint.style.color = "#48BB78";
          e.target.style.borderColor = "#48BB78";
        } else {
          usernameHint.textContent =
            "3-50 characters, letters, numbers, and underscores only";
          usernameHint.style.color = "";
          e.target.style.borderColor = "";
        }
      });

      // Check if username exists (with debounce)
      let usernameCheckTimeout;
      usernameInput.addEventListener("blur", async () => {
        const username = usernameInput.value.trim();

        if (username.length < 3) return;

        clearTimeout(usernameCheckTimeout);
        usernameCheckTimeout = setTimeout(async () => {
          try {
            const { data, error } = await supabaseClient
              .from("users")
              .select("username")
              .eq("username", username)
              .single();

            if (data) {
              usernameHint.textContent = "❌ Username already taken";
              usernameHint.style.color = "#F56565";
              usernameInput.style.borderColor = "#F56565";
            } else if (error && error.code === "PGRST116") {
              // No user found - username is available
              usernameHint.textContent = "✓ Username available";
              usernameHint.style.color = "#48BB78";
              usernameInput.style.borderColor = "#48BB78";
            }
          } catch (err) {
            console.error("Username check error:", err);
          }
        }, 500);
      });

      // ==========================================
      // EMAIL VALIDATION
      // ==========================================
      const emailInput = document.getElementById("email");
      const emailHint = document.getElementById("emailHint");

      emailInput.addEventListener("blur", async () => {
        const email = emailInput.value.trim();

        if (!email) return;

        try {
          const { data, error } = await supabaseClient
            .from("users")
            .select("email")
            .eq("email", email)
            .single();

          if (data) {
            emailHint.textContent = "❌ Email already registered";
            emailHint.style.color = "#F56565";
            emailInput.style.borderColor = "#F56565";
          } else if (error && error.code === "PGRST116") {
            // No user found - email is available
            emailHint.textContent = "✓ Email available";
            emailHint.style.color = "#48BB78";
            emailInput.style.borderColor = "#48BB78";
          }
        } catch (err) {
          console.error("Email check error:", err);
        }
      });

      // ==========================================
      // SIGN UP LOGIC
      // ==========================================
      const signupForm = document.getElementById("signupForm");
      const roleInputs = document.querySelectorAll('input[name="role"]');
      const yearGroupSection = document.getElementById("yearGroupSection");

      // Show/hide year group based on role
      roleInputs.forEach((input) => {
        input.addEventListener("change", (e) => {
          if (e.target.value === "student") {
            yearGroupSection.style.display = "block";
          } else {
            yearGroupSection.style.display = "none";
          }
        });
      });

      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const role = document.querySelector('input[name="role"]:checked').value;
        const yearGroup = document.getElementById("yearGroup").value;

        const errorMessage = document.getElementById("errorMessage");
        const submitBtn = document.getElementById("submitBtn");

        // Clear previous errors
        errorMessage.style.display = "none";

        // Username format validation
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          errorMessage.textContent =
            "Username can only contain letters, numbers, and underscores";
          errorMessage.style.display = "block";
          return;
        }

        if (username.length < 3 || username.length > 50) {
          errorMessage.textContent =
            "Username must be between 3 and 50 characters";
          errorMessage.style.display = "block";
          return;
        }

        // Password validation
        if (password !== confirmPassword) {
          errorMessage.textContent = "Passwords do not match";
          errorMessage.style.display = "block";
          return;
        }

        if (password.length < 8) {
          errorMessage.textContent =
            "Password must be at least 8 characters long";
          errorMessage.style.display = "block";
          return;
        }

        // Year group validation for students
        if (role === "student" && !yearGroup) {
          errorMessage.textContent = "Please select your year group";
          errorMessage.style.display = "block";
          return;
        }

        // Show loading state
        submitBtn.classList.add("btn-loading");
        submitBtn.disabled = true;

        try {
          console.log("Starting signup process...");

          // Check username uniqueness
          const { data: existingUsername, error: usernameCheckError } =
            await supabaseClient
              .from("users")
              .select("username")
              .eq("username", username)
              .single();

          if (existingUsername) {
            throw new Error(
              "Username already taken. Please choose another one.",
            );
          }

          // Check email uniqueness
          const { data: existingEmail, error: emailCheckError } =
            await supabaseClient
              .from("users")
              .select("email")
              .eq("email", email)
              .single();

          if (existingEmail) {
            throw new Error(
              "Email already registered. Please use another email or try logging in.",
            );
          }

          console.log("Username and email are available");

          // Sign up with Supabase Auth
          const { data: authData, error: authError } =
            await supabaseClient.auth.signUp({
              email: email,
              password: password,
              options: {
                data: {
                  username: username,
                  role: role,
                  year_group: role === "student" ? yearGroup : null,
                },
              },
            });

          if (authError) {
            console.error("Auth signup error:", authError);
            throw authError;
          }

          console.log("Auth signup successful:", authData);

          // The trigger will create the profile automatically
          // Wait a moment for the trigger to complete
          await new Promise((resolve) => setTimeout(resolve, 1000));

          console.log("Profile created successfully");

          alert(
            "Account created successfully! Please check your email to verify your account before logging in.",
          );

          // Redirect to login page
          setTimeout(() => {
            window.location.href = "./login.html";
          }, 1500);
        } catch (error) {
          console.error("Sign up error:", error);

          let errorMsg = error.message || "An error occurred during sign up";

          if (error.message?.includes("already registered")) {
            errorMsg =
              "This email is already registered. Please log in instead.";
          } else if (error.message?.includes("already taken")) {
            errorMsg =
              "This username is already taken. Please choose another one.";
          } else if (error.message?.includes("Password")) {
            errorMsg = "Password must be at least 8 characters long";
          } else if (error.code === "23505") {
            if (error.message?.includes("username")) {
              errorMsg = "Username already taken";
            } else if (error.message?.includes("email")) {
              errorMsg = "Email already registered";
            }
          }

          errorMessage.textContent = errorMsg;
          errorMessage.style.display = "block";
        } finally {
          submitBtn.classList.remove("btn-loading");
          submitBtn.disabled = false;
        }
      });
    </script>

    <!-- Load global scripts -->
    <script src="../script.js"></script>
  </body>
</html>
