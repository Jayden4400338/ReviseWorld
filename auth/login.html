<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - BrainMapRevision</title>
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="../assets/css/auth.css" />
    <link rel="shortcut icon" href="../assets/images/shortcut-icon.png" />
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <svg
            class="logo-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"
            />
            <path
              d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"
            />
          </svg>
          <span class="logo-text">BrainMapRevision</span>
        </div>

        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <span></span>
          <span></span>
          <span></span>
        </button>

        <div class="nav-menu" id="navMenu">
          <a href="../index.html" class="nav-link">Home</a>
          <a href="signup.html" class="nav-link">Sign Up</a>
          <button
            class="theme-toggle"
            id="themeToggle"
            aria-label="Toggle dark mode"
          >
            <svg
              class="sun-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="5" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
              <line x1="1" y1="12" x2="3" y2="12" />
              <line x1="21" y1="12" x2="23" y2="12" />
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
            </svg>
            <svg
              class="moon-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
          </button>
        </div>
      </div>
    </nav>

    <!-- Login Form -->
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1 class="auth-title">Welcome Back!</h1>
          <p class="auth-subtitle">Continue your revision journey</p>
        </div>

        <form id="loginForm" class="auth-form">
          <!-- Email -->
          <div class="form-group">
            <label for="email" class="form-label">Email Address</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="your.email@example.com"
              required
            />
          </div>

          <!-- Password -->
          <div class="form-group">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              id="password"
              class="form-input"
              placeholder="Enter your password"
              required
            />
          </div>

          <!-- Remember Me & Forgot Password -->
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="rememberMe" />
              <label for="rememberMe">Remember me</label>
            </div>
            <a href="reset-password.html" class="auth-link forgot-password-link"
              >Forgot password?</a
            >
          </div>

          <!-- Error Message -->
          <div
            id="errorMessage"
            class="error-message"
            style="display: none"
          ></div>

          <!-- Success Message -->
          <div
            id="successMessage"
            class="success-message"
            style="display: none"
          ></div>

          <!-- Submit Button -->
          <button type="submit" class="btn btn-primary btn-full" id="submitBtn">
            <span>Log In</span>
            <svg
              class="btn-icon"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
              <polyline points="10 17 15 12 10 7" />
              <line x1="15" y1="12" x2="3" y2="12" />
            </svg>
          </button>

          <!-- Resend Verification Section (hidden by default) -->
          <div id="resendVerificationSection" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px;">
            <p style="margin: 0 0 10px 0; color: var(--text-primary); font-size: 0.9rem;">
              Your email address hasn't been verified yet.
            </p>
            <button type="button" id="resendVerificationBtn" class="btn btn-secondary" style="width: 100%;">
              <span>Resend Verification Email</span>
            </button>
            <p id="resendStatus" style="margin: 10px 0 0 0; font-size: 0.85rem; color: var(--text-secondary);"></p>
          </div>

          <!-- Resend Verification Link -->
          <p class="auth-footer" style="margin-top: 10px;">
            <a href="resend-verification.html" class="auth-link">Resend verification email</a>
          </p>

          <!-- Sign Up Link -->
          <p class="auth-footer">
            Don't have an account?
            <a href="signup.html" class="auth-link">Sign up</a>
          </p>
        </form>
      </div>
    </div>

    <!-- Load Environment Configuration FIRST -->
    <script src="../assets/js/env-config.js"></script>
    
    <!-- Load Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Inline Supabase Config & Auth Logic -->
    <script>
      // ==========================================
      // SUPABASE CONFIGURATION
      // ==========================================
      // Get configuration from environment (set by env-config.js)
      const SUPABASE_URL = window.__ENV__?.SUPABASE_URL || "https://qqbyxydxxcuklakvjlfr.supabase.co";
      const SUPABASE_ANON_KEY = window.__ENV__?.SUPABASE_ANON_KEY || "Your-anon-key-here";

      // Initialize Supabase client - ONLY CREATE ONCE
      if (!window.supabaseClient) {
        window.supabaseClient = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY,
        );
      }

      // Use the global client
      const supabaseClient = window.supabaseClient;

      
      const loginForm = document.getElementById("loginForm");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");
      const submitBtn = document.getElementById("submitBtn");

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const rememberMe = document.getElementById("rememberMe").checked;

        // Clear previous messages
        errorMessage.style.display = "none";
        successMessage.style.display = "none";

        // Show loading state
        submitBtn.classList.add("btn-loading");
        submitBtn.disabled = true;

        try {
          console.log("Attempting login for:", email);

          // Sign in with Supabase
          const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password,
          });

          if (error) {
            console.error("Login error:", error);
            
            // Check if user exists but email is not verified
            if (error.message?.includes('Email not confirmed') || 
                error.message?.includes('email_not_confirmed') ||
                error.status === 400) {
              
              // Try to get user to check verification status
              const { data: { user } } = await supabaseClient.auth.getUser();
              
              // Show resend verification option
              showResendVerificationOption(email);
              throw new Error('Please verify your email address. Check your inbox for the verification email, or click below to resend it.');
            }
            
            throw error;
          }
          
          // Check if user is verified
          if (data.user && !data.user.email_confirmed_at) {
            showResendVerificationOption(email);
            throw new Error('Please verify your email address before logging in. Check your inbox or click below to resend the verification email.');
          }

          console.log("Login successful!", data);

          // Update last login time
          try {
            await supabaseClient
              .from("users")
              .update({ last_login: new Date().toISOString() })
              .eq("id", data.user.id);
          } catch (updateError) {
            console.warn("Could not update last login:", updateError);
            // Don't fail login if this fails
          }

          // Store session if remember me is checked
          if (rememberMe) {
            localStorage.setItem("rememberMe", "true");
          }

          // Show success message
          successMessage.textContent = "Login successful! Redirecting...";
          successMessage.style.display = "block";

          // Redirect to dashboard
          setTimeout(() => {
            window.location.href = "../pages/dashboard.html";
          }, 1000);
        } catch (error) {
          console.error("Login error:", error);
          errorMessage.textContent =
            error.message || "Invalid email or password. Please try again.";
          errorMessage.style.display = "block";

          submitBtn.classList.remove("btn-loading");
          submitBtn.disabled = false;
        }
      });

      // ==========================================
      // RESEND VERIFICATION EMAIL
      // ==========================================
      const resendVerificationSection = document.getElementById("resendVerificationSection");
      const resendVerificationBtn = document.getElementById("resendVerificationBtn");
      const resendStatus = document.getElementById("resendStatus");
      let currentEmailForResend = "";

      function showResendVerificationOption(email) {
        currentEmailForResend = email;
        if (resendVerificationSection) {
          resendVerificationSection.style.display = "block";
        }
      }

      if (resendVerificationBtn) {
        resendVerificationBtn.addEventListener("click", async () => {
          if (!currentEmailForResend) {
            currentEmailForResend = document.getElementById("email").value.trim();
          }

          if (!currentEmailForResend) {
            resendStatus.textContent = "Please enter your email address first.";
            resendStatus.style.color = "#F56565";
            return;
          }

          resendVerificationBtn.disabled = true;
          resendVerificationBtn.innerHTML = '<span>Sending...</span>';
          resendStatus.textContent = "";
          resendStatus.style.color = "";

          try {
            console.log("Resending verification to:", currentEmailForResend);
            const { data, error } = await supabaseClient.auth.resend({
              type: 'signup',
              email: currentEmailForResend,
              options: {
                emailRedirectTo: window.location.origin + '/auth/login.html'
              }
            });
            
            console.log("Resend response:", data);

            if (error) throw error;

            resendStatus.textContent = "Verification email sent! Please check your inbox.";
            resendStatus.style.color = "#10B981";
            resendVerificationBtn.innerHTML = '<span>Email Sent âœ“</span>';
            
            setTimeout(() => {
              resendVerificationBtn.disabled = false;
              resendVerificationBtn.innerHTML = '<span>Resend Verification Email</span>';
            }, 3000);

          } catch (error) {
            console.error("Resend verification error:", error);
            resendStatus.textContent = error.message || "Failed to send verification email. Please try again.";
            resendStatus.style.color = "#F56565";
            resendVerificationBtn.disabled = false;
            resendVerificationBtn.innerHTML = '<span>Resend Verification Email</span>';
          }
        });
      }

      // ==========================================
      // CHECK IF ALREADY LOGGED IN
      // ==========================================
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const {
            data: { session },
          } = await supabaseClient.auth.getSession();

          if (session) {
            console.log("User already logged in, redirecting...");
            window.location.href = "../pages/dashboard.html";
          }
        } catch (error) {
          console.error("Session check error:", error);
        }
      });
    </script>

    <!-- Load global scripts -->
    <script src="../script.js"></script>
  </body>
</html>
